language: php
php:
  - '7.2'
  - '7.1'
  - '7.0'
  - '5.6'
  - '5.5'
  - '5.4'
sudo: false
branches:
  except:
    - "/^*-v[0-9]/"
env:
  matrix:
    - WP_VERSION=latest WP_MULTISITE=0
  global:
    - MASTER_BRANCH=master UPSTREAM_REPO=Codeinwp/optimole-wp DEPLOY_BUILD=7.0
    - CC_TEST_REPORTER_ID=b6145e78ee9b35206e3eec359227b1645923db67fe0459b437cfe1589b5ab2b8
before_install:
  - mkdir -p bin && cd bin
  - wget "$PIRATE_FLEET"load.sh
  - cd .. && chmod +x bin/load.sh
  - ". ./bin/load.sh"
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
install:
  - chmod +x bin/install-dependencies.sh
  - ". ./bin/install-dependencies.sh"
script:
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then  grunt travis; fi;
after_script:
  - ./cc-test-reporter format-coverage -t simplecov -o coverage/codeclimate.backend.json coverage/backend/.resultset.json # Format backend coverage
  - ./cc-test-reporter format-coverage -t lcov -o coverage/codeclimate.frontend.json coverage/frontend/lcov.info  # Format frontend coverage
  - ./cc-test-reporter sum-coverage coverage/codeclimate.*.json -p 2                  # Sum both coverage parts into coverage/codeclimate.json
  - if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then ./cc-test-reporter upload-coverage; fi  # Upload coverage/codeclimate.json
before_deploy:
  - chmod +x bin/prepare-deploy.sh
  - ". ./bin/prepare-deploy.sh"
deploy:
  - provider: s3
    access_key_id: "$AWS_ACCESS_KEY"
    secret_access_key: "$AWS_SECRET_KEY"
    bucket: "$AWS_BUCKET"
    skip_cleanup: true
    acl: public_read
    overwrite: true
    local-dir: artifact/
    upload-dir: "$AWS_PRODUCTS_FOLDER/$THEMEISLE_REPO/latest"
    on:
      branch: "$MASTER_BRANCH"
      repo: "$UPSTREAM_REPO"
      condition: "$TRAVIS_PHP_VERSION = $DEPLOY_BUILD"
  - provider: s3
    access_key_id: "$AWS_ACCESS_KEY"
    secret_access_key: "$AWS_SECRET_KEY"
    bucket: "$AWS_BUCKET"
    skip_cleanup: true
    acl: public_read
    overwrite: true
    local-dir: artifact/
    upload-dir: "$AWS_PRODUCTS_FOLDER/$THEMEISLE_REPO/$THEMEISLE_VERSION"
    on:
      repo: "$UPSTREAM_REPO"
      branch: "$MASTER_BRANCH"
      condition: "$TRAVIS_PHP_VERSION = $DEPLOY_BUILD"
after_deploy:
  - chmod +x bin/deploy.sh
  - ". ./bin/deploy.sh"
after_failure:
  - cat logs/phpcs.log